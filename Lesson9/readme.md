# Урок №9: Запись JSON данных в PostgreSQL

## Структура целевой таблицы
```
CREATE TABLE postgres.public.test (
    id bigint NOT NULL DEFAULT nextval('test_id_seq'::regclass),
    data json,
    insert_dt timestamp(3),
    CONSTRAINT test_pkey PRIMARY KEY (id)
);
```

## Способы записи данных

### 1. Метод разбивки (PutSQL)

__Процесс:__
1. GenerateRecord создает JSON записи
2. SplitText разделяет записи по строкам
3. EvaluateJsonPath извлекает поля (весь json объект целиком)
4. PutSQL выполняет вставку

__SQL запрос:__
```
INSERT INTO public.test (data, insert_dt) 
VALUES (?::json, ?::timestamp);
```

__Ключевые настройки:__
- Batch Size: 1 
- Transaction Timeout: 30 сек

### 2. Метод прямой записи (PutDatabaseRecord)

__Процесс:__
1. GenerateRecord создает записи
2. UpdateRecord добавляет текущую дату
3. PutDatabaseRecord выполняет вставку

__Особые настройки CSV Reader:__

| Параметр                      | Значение  | Назначение                          |
|-------------------------------|-----------|-------------------------------------|
| Value Separator               | \t        | Разделитель полей                   |
| Record Separator              | \n        | Разделитель записей                 |
| Treat First Line as Header    | false     | Игнорировать заголовки              |
| Quote Character               | ♥         | Экранирование спецсимволов          |
| Escape Character              | ▲         | Экранирование кавычек               |

## Практическое задание

### Часть 1: Сравнение методов
1. Настройте оба потока обработки
2. Запустите с идентичными наборами данных (10 записей)
3. Замерьте:
   - Время выполнения

### Часть 2: Оптимизация Batch Size
1. Для PutSQL протестируйте разные значения Batch Size:
   ```
   1, 10, 50, 100, 500, 1000
   ```
2. Постройте график зависимости:
   - Времени выполнения от Batch Size
   - Потребления памяти от Batch Size

3. Определите "золотую середину" для вашей системы

### Контрольные вопросы:
1. Почему специальные символы (♥, ▲) используются в CSV Reader?
2. Как Batch Size влияет на транзакционность?
3. В каком случае PutSQL предпочтительнее PutDatabaseRecord?

## Выводы

### Производительность:

| Метод              | Скорость | Память | Удобство |
|--------------------|----------|--------|----------|
| PutSQL             | ▲▲▲      | ▲▲     | ▲▲       |
| PutDatabaseRecord  | ▲▲       | ▲▲▲    | ▲▲▲      |

### Рекомендации:
1. __Для небольших JSON:__  
   PutDatabaseRecord с CSV Reader  
   - Проще в настройке  
   - Лучшая читаемость потока  

2. __Для больших объемов:__  
   PutSQL с Batch Size = 100-500  
   - Лучшая производительность  
   - Точный контроль над транзакциями  

3. __Критические системы:__  
   - Тестируйте разные Batch Size  
   - Мониторьте нагрузку при длинных транзакциях  

### Оптимальные параметры:
- Batch Size: 100-300 (зависит от размера записи)
- Transaction Timeout: 30-60 сек
- Формат даты: yyyy-MM-dd HH:mm:ss.SSS
